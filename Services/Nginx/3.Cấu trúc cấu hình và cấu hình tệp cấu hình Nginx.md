#  Cấu trúc cấu hình và cấu hình tệp cấu hình Nginx.

-  Với nginx tất cả cấu hình nằm trong thư mục: `/etc/nginx`
   - `/etc/nginx/nginx.conf`: là file cấu hình tổng quan
   -  `/etc/nginx/sites-available/`: thư mục các file cấu hình khối máy chủ trên mỗi trang web. Nginx chỉ có thể sử dụng khi kích hoạt khối tại thư mục sites-enabled.
   -  `/etc/nginx/sites-enabled/`-  Thư mục dùng để kích hoạt các khối máy chủ của mỗi trang web. Thông thường tạo liên kết file từ thư mục sites-available để dễ dàng quản lý và bật tắt size.
   -  Mặc định thư mục `/var/www/html/` hoặc thư mục `/usr/share/html`: là thư mục nội dung website
- Lưu ý: Trước khi thay đổi cấu hình, sao lưu lại file cấu hình:
```
cp /etc/nginx/conf/nginx.conf /etc/nginx/conf/nginx.conf.backup
```
## Cấu trúc tệp cấu hình nginx
- File cấu hình tổng quan nằm ở `/etc/nginx/nginx.conf`.  
- Nó cũng có thể ở `/usr/local/nginx/nginx.conf` hoặc `usr/local/etc/nginx/nginx/conf` tuỳ theo bản phân phối.
- Nội dung config file của nginx:
```
user  nginx;
worker_processes  auto;

error_log  /var/log/nginx/error.log notice;
pid        /var/run/nginx.pid;


events {
    worker_connections  1024;
}


http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /var/log/nginx/access.log  main;

    sendfile        on;
    #tcp_nopush     on;

    keepalive_timeout  65;

    #gzip  on;

    include /etc/nginx/conf.d/*.conf;
}
```
- Các `blocks` mở đầu bằng dấu `{` và kết thúc bằng dấu `}`, nội bên trong 1 `block` hay `context` gồm một hoặc nhiều các `directive`. Các tùy chọn cấu hình trong Nginx được gọi là `directive`.
- Các `block` có thể được viết lồng nhau giúp các block con kế thừa các `directive` từ block cha - block bao quanh nó. Ngoài ra, trong block con ta cũng có thể được ghi đè các giá trị `directive` được kế thừa tử cha bởi các giá trị theo ý muốn.
- Ký tự # đứng trước là các comment và không được Nginx thực thi. Các dòng chứa directive phải kết thúc bằng dấu `;`
- Nginx sẽ báo lỗi khi đọc tệp cấu hình với các lệnh được khai báo trong context bị sai. Tới đây ta sẽ tóm gọn lại cấu trúc của một tệp cấu hình:
```
user  nginx;
worker_processes  number_process;

error_log  /var/log/nginx/error.log;
pid        /var/run/nginx.pid;

events {
       . . .
}

http {
       . . .
}
```
-   Tệp bắt đầu với 4 directive: user, worker_processes, error_log, pid. Những directive này nằm ngoài cặp ngoặc nhọn và không thuộc context nào, ảnh hưởng đến toàn bộ ứng dụng ở mức cơ bản. Ta gọi nó là main context. Hai block là events và http là các directive bổ sung. Chúng tồn tại trong main context.

### Events context
-   Events context ở trong main context. Nó được sử dụng để đặt các directive mức global, ảnh hưởng đến cách Nginx xử lý các kết nối. Chỉ có duy nhất 1 event context được định nghĩa trong cấu hình Nginx.
```
# main context

events {

    # events context
    . . .

}
```
- Nginx sử dụng mô hình xử lý kết nối dựa trên hướng sự kiện. Do đó, các directive nằm trong context này sẽ xác định cách mà các worker process nên xử lý các connect như thế nào.

- Thông thường, phương thức xử lý kết nối được chọn tự động dựa trên sự lựa chọn hiệu quả nhất mà nền tảng đang sẵn có. Đối với hệ thống Linux thì epoll chính là phương thức tối ưu nhất.
### Http context
- Đồng bậc với events context là Http context. Nó cũng nằm trong main context. Nếu cấu hình Nginx với mục đích làm máy chủ web hoặc reverse proxy thì http context sẽ giữ phần lớn cấu hình. Nó sẽ chứa tất cả các directive và các context cần thiết để xác định cách chương trình sẽ xử lý các kết nối HTTP hoặc HTTPS. Http context chứa các directive để xử lý lưu lượng truy cập web.
```
# main context

events {
    # events context

    . . .

}

http {
    # http context

    . . .

}
```
### Server context
- Mỗi server context xác định một máy chủ ảo để xử lý các yêu cầu của máy khách. Mỗi một máy chủ ảo có thể xử lý một tập hợp con cụ thể các kết nối khác nhau.
```
# main context

http {

    # http context

    server {

        # first server context

    }

    server {

        # second server context

    }

```
### Listen port
- Mỗi listen port đại diện cho 1 Nginx hostname và cổng TCP sẽ lắng nghe các kết nối HTTP. Nếu một request từ client phù hợp với các giá trị này, khối này sẽ có khả năng được chọn để xử lý kết nối.
```
server {
		listen     localhost:110;
		###
}
```
### Name-Based Virtual Hosting
- server_name cho phép nhiều tên miền được trỏ tới cùng 1 địa chỉ IP. Nginx sử dụng tên miền từ HTTP header để trả lời các yêu cầu. Bất kể, tên miền có hợp lệ hay không.
- Dưới đây chúng ta tạo file config cho các domain có tên là domain_name cụ thể như sau :
    - trong /etc/nginx/conf.d/domain_name.com.conf có nội dung sau
```
server_name   domain_name.com www.domain_name.com;
```
-   Hoàn toàn có thể định nghĩa server_name ngay bên trong /ect/nginx/nginx.conf như này ( thuộc server context)
```
# main context
server {
		listen     localhost:110;
		server_name     domain_name.com
}
```
### Location context
```
location match_modifier location_match {

    . . .

}
```


